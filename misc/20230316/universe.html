<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Platonov</title>
    <meta charset="utf-8" />
    <meta name="author" content="Никита Платонов" />
    <script src="https://nplatonov.github.io/site_libs/header-attrs-2.20/header-attrs.js"></script>
    <link href="https://nplatonov.github.io/site_libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="https://nplatonov.github.io/site_libs/remark-css-0.0.1/hygge.css" rel="stylesheet" />
    <link href="https://nplatonov.github.io/site_libs/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="https://nplatonov.github.io/site_libs/tile-view-0.2.6/tile-view.js"></script>
    <link href="https://nplatonov.github.io/site_libs/animate.css-3.7.2/animate.xaringan.css" rel="stylesheet" />
    <link href="https://nplatonov.github.io/site_libs/panelset-0.2.6/panelset.css" rel="stylesheet" />
    <script src="https://nplatonov.github.io/site_libs/panelset-0.2.6/panelset.js"></script>
    <link rel="stylesheet" href="https://nplatonov.github.io/site_libs/common.css" type="text/css" />
    <link rel="stylesheet" href="https://nplatonov.github.io/site_libs/moon_reader.css" type="text/css" />
    <link rel="stylesheet" href="https://nplatonov.github.io/site_libs/moon_reader-fonts.css" type="text/css" />
  </head>
  <body>
<style>
.remark-backdrop:after{
   content: 'Никита Платонов \A \A Программное обеспечение сопровождения научно-исследовательских работ по белому медведю';
}
:root {--pointsize: 22pt;}
</style>

    <textarea id="source">

layout: true







.banner[


.remarkonly[

.center[
<img src="assets/pbu-logo.jpg" width="156" />
<br>
<img src="assets/sevin.jpg" width="71" />
<img src="assets/sevin-expedition.png" width="82" />
<br>
<br>
<br>
]

]

.shorttitle[

]

]

---
class: metadata customtitle middle left
name: H3216
<iframe width='220' height='220' class='timenow' src='https://www.timeanddate.com/worldclock/fullscreen.html?n=1440' frameborder='0' allow='encrypted-media' allowfullscreen></iframe>

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f)
]
.mainbar.right-column[





.author[Nikita&nbsp;Platonov]


.institute[A. N. Severtsov Institute of Ecology and Evolution of Russian Academy of Sciences]




.title[Software and dataware integration to polar bear studies]


.subtitle[Experiences of the Permanent Expedition of Russian Academy of Sciences]


.what[VI<sup>th</sup> International Scientific and Practical Conference "Polar Bear Universe: Results of Researches 2012-2022, Plans for the Future", March 15-17, 2023]


.where[Anadyr, Chukotka]


.when[16 March 2023 .updated[Updated: 2023-03-16 04:50]]



]
---

name: H4a95

.sidebar.left-column[
# [Researches](#H4a95).fg[].bg[]
# [Field work](#H6e42)
# [Office work](#H201f)
]
.mainbar.right-column[






















 ### «The Program For Polar Bear Researches In The Russian Arctic»

Performed by the Permanent Expedition of Russian Academy of Sciences

Comprehensive polar bear study:

.font90[

+ Estimating spatial-temporal distribution of polar bears

+ Evaluating polar bear movement patterns and habitat use parameters in the different temporal resolutions using satellite biotelemetry

+ Studying polar bear reproductive biology

+ Investigating feeding, provision by food resources, the dynamics of primary preys of polar bear

+ Detection natural and human-induced factors, which influence to polar bear reproduction and survival

+ Genetic identification of polar bears

+ Studying of intra-annual and inter-annual variability of sea ice and other habitat parameters

]


]
???
Цель: комплексное изучение белого медведя как вида




+ Изучение пространственно-временного размещения животных в зависимости от факторов окружающей среды.

+ Оценка перемещений белого медведя и характера использования им местообитаний.

+ Изучение репродуктивной биологии белого медведя.

+ Изучение половозрастной структуры и демографических показателей популяций.

+ Изучение питания, кормовых ресурсов, распределения и динамики основных видов жертв белого медведя.

+ Изучение взаимоотношений белого медведя с другими видами животных и человеком.

+ Изучение роли природных и антропогенных факторов в динамике численности с особым вниманием к последствиям воздействия на популяции загрязняющих веществ, патогенных организмов и изменения климата.

+ Уточнение популяционной структуры географических популяций белого медведя с применением молекулярно-генетического и других современных методов анализа.

+ Изучение сезонной и межгодовой динамики ледовых местообитаний












---

name: H6e42

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42).fg[].bg[]
## [Ice conditions](#H14ea)
## [Weather forecast](#Hd14f)
# [Office work](#H201f)
]
.mainbar.right-column[


.font93[

Issues:

+ Data traffic is limited by volume and speed, with interrupted sessions

+ Data are required to be near real-time.

Solutions:

+ Tasks by schedule or requests on server, located with favorable traffic conditions. Output is text summary or lightweight figures.

+ Scripts for automatic data download during low traffic periods of sleeping or outdoor activity.

+ API usage instead of interactive and multi-step browser requests.

   + Argos satellite biotelemetry data – SOAP requests, with additional profit in uniform date format.
   
   + Web map services (WMS) and tile map services (TMS) – data volume is defined by screen resolution

+ Emergency assistance – voice or messages via Iridium satellite phones

]


]
???



Проблема:

+ Ограничения объема и скорости передачи данных, нередки обрывы

+ Необходимость получения данных в реальном времени

Применяемые решения:

+ Получение и обработке данных «хостом» (сервер или человек), на выходе сводка и легковесные картинки.

+ Скрипты для автоматического получения данных ночью или во время «выезда в поле»

+ Использование API вместо интерактивных запросов в браузере

   + Спутниковая биотелеметрия Argos (SOAP) – стандартизация разделителей и формата данных
   
   + Картографические интернет сервисы TMS и WMS – разрешение данных по размеру экрана

+ «Помощь друга» – голосовая спутниковая связь


---

name: H14ea

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42).fg[]
## [Ice conditions](#H14ea) <span class="bullet bullet-active">[&#8226;](#H14ea)</span><span class="bullet mslide9m">[&#8226;](#Ha5c4)</span>.fg[].bg[]
## [Weather forecast](#Hd14f)
# [Office work](#H201f)
]
.mainbar.right-column[


Sentinel-1 active microwave data

<div class="figure" style="text-align: center">
<img src="assets/S1B_EW_GRDM_1SDH_20210419T042651_20210419T042751_026531_032B0C_C096-ql.jpg" alt="Scene S1B_EW_GRDM_1SDH_20210419T042651_20210…<sup><a href=#fn>1</a></sup><span id=ref1></span> (~200 МB)" width="1330" height="568" />
<p class="caption">Scene S1B_EW_GRDM_1SDH_20210419T042651_20210…<sup><a href=#fn>1</a></sup><span id=ref1></span> (~200 МB)</p>
</div>


]
---

name: Ha5c4

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42).fg[]
## [Ice conditions](#H14ea) <span class="bullet bullet">[&#8226;](#H14ea)</span><span class="bullet bullet-active">[&#8226;](#Ha5c4)</span>.fg[].bg[]
## [Weather forecast](#Hd14f)
# [Office work](#H201f)
]
.mainbar.right-column[


Visual control for landfast ice continuity

<div class="figure" style="text-align: center">
<img src="assets/hv-20210419-0426.png" alt="Required figure/image size is 100-200 KB" width="1330" height="568" />
<p class="caption centered">Required figure/image size is 100-200 KB</p>
</div>


]
---

name: Hd14f

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42).fg[]
## [Ice conditions](#H14ea)
## [Weather forecast](#Hd14f) <span class="bullet bullet-active">[&#8226;](#Hd14f)</span><span class="bullet mslide13m">[&#8226;](#H508a)</span>.fg[].bg[]
# [Office work](#H201f)
]
.mainbar.right-column[






.dontscrollable[

Raw GFS atmosphere data in GRIB format: sea level pressure, cloud fraction and wind on geopotential height levels (aerial survey), horizontal visibility, precipitation rates, *etc*.

<img src="assets/cloud-AeroVolga.png" width="1330" height="545" bound style="display: block; margin: auto;" />
]


]
???



Данные GFS по атмосферной циркуляции: давление на уровне моря, фракция облачности и ветер по уровням геопотенциальных высот, горизонтальная видимость, осадки *и др.*

---

name: H508a

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42).fg[]
## [Ice conditions](#H14ea)
## [Weather forecast](#Hd14f) <span class="bullet bullet">[&#8226;](#Hd14f)</span><span class="bullet bullet-active">[&#8226;](#H508a)</span>.fg[].bg[]
# [Office work](#H201f)
]
.mainbar.right-column[


.remarkonly[

.panelset[

.panel[
.panel-name[SLP]
<div class="figure" style="text-align: center">
<img src="assets/cloud1-PRMSL0.png" alt="Sea level pressure" width="1330" height="568" aspect />
<p class="caption centered">Sea level pressure</p>
</div>
]

.panel[
.panel-name[GUST]
<div class="figure" style="text-align: center">
<img src="assets/cloud2-GUST0.png" alt="Wind gusts at surface level" width="1330" height="568" aspect />
<p class="caption centered">Wind gusts at surface level</p>
</div>
]

.panel[
.panel-name[H1000]
<div class="figure" style="text-align: center">
<img src="assets/cloud3-TCDC1000.png" alt="Total cloud fraction and wind at level 1000 mbar" width="1330" height="568" aspect />
<p class="caption centered">Total cloud fraction and wind at level 1000 mbar</p>
</div>
]

.panel[
.panel-name[H950]
<div class="figure" style="text-align: center">
<img src="assets/cloud5-TCDC950.png" alt="Total cloud fraction and wind at level 950 mbar" width="1330" height="568" aspect />
<p class="caption centered">Total cloud fraction and wind at level 950 mbar</p>
</div>
]

.panel[
.panel-name[VIS]
<div class="figure" style="text-align: center">
<img src="assets/cloud6-VIS0.png" alt="Visibility at surface level" width="1330" height="568" aspect />
<p class="caption centered">Visibility at surface level</p>
</div>
]

.panel[
.panel-name[PR]
<div class="figure" style="text-align: center">
<img src="assets/cloud7-PRATE0.png" alt="Precipitation rate at surface level" width="1330" height="568" aspect />
<p class="caption centered">Precipitation rate at surface level</p>
</div>
]

.panel[
.panel-name[CPR]
<div class="figure" style="text-align: center">
<img src="assets/cloud8-CPRAT0.png" alt="Convective precipitation rate at surface level and air temperature at level 2m above ground" width="1330" height="568" aspect />
<p class="caption">Convective precipitation rate at surface level and air temperature at level 2m above ground</p>
</div>
]

]

]


]
---

name: H201f

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[].bg[]
## [Polar bear tracking](#H39f1)
## [Trajectory analysis](#H4821)
## [Environmental conditions](#He059)
]
.mainbar.right-column[


 ## Reproducible researces

.font100[

Code (program):

+ converts raw data to processed data

+ does data analysis

+ implements literate programming

   + includes output (tables, figures, inline text)

+ gets results for a new data set

Implementation: input <img alt="R" class="inline" src=https://cran.rstudio.com/Rlogo.svg> code,
integrated to extended
(Rmarkdown  <img class="inline" src=https://github.com/rstudio/rmarkdown/raw/main/man/figures/logo.png>)
markup language Markdown <img class="inline" src=https://seeklogo.com/images/M/markdown-logo-102FDA095E-seeklogo.com.png?v=637829616810000000>,
is converted by
<img alt="Pandoc" class="inline" src="assets/pandoc.png">
tool to formatted documents in various formats. 

Collaboration: web applications
<img alt="Shiny" class="inline" src=https://shiny.rstudio.com/images/shiny-solo.svg>

+ Server avoids software (IDEs, GIS) installing

+ Client (GUI) avoids coding

]


]
???
Популяризация: веб-приложения Shiny


+ Программный код

   + преобразует необработанные данные в обработанные данные
   
   + выполняет анализ данных
   
   + включает результаты анализа в отчет
   
   + позволяет получить результат на новом наборе данных

Реализация:
язык программирования R, внедренный в язык текстовой разметки markdown
(Rmarkdown), преобразуется утилитой Pandoc в документы различных форматов. 



+ Не нужно устанавливать программное обеспечение (ГИС, IDE)

+ Графическая оболочка скрывает программирование

---

name: H39f1

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[]
## [Polar bear tracking](#H39f1) <span class="bullet bullet-active">[&#8226;](#H39f1)</span><span class="bullet mslide18m">[&#8226;](#Hc758)</span>.fg[].bg[]
## [Trajectory analysis](#H4821)
## [Environmental conditions](#He059)
]
.mainbar.right-column[




































<img src="assets/argos.png" width="1330" height="568" image style="display: block; margin: auto;" />

]
---

name: Hc758

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[]
## [Polar bear tracking](#H39f1) <span class="bullet bullet">[&#8226;](#H39f1)</span><span class="bullet bullet-active">[&#8226;](#Hc758)</span>.fg[].bg[]
## [Trajectory analysis](#H4821)
## [Environmental conditions](#He059)
]
.mainbar.right-column[


<iframe src="https://wwfrussia.shinyapps.io/argos?branch=somov" width="1330" height="650px" data-external="1" freeze></iframe>





]
---

name: H4821

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[]
## [Polar bear tracking](#H39f1)
## [Trajectory analysis](#H4821) <span class="bullet bullet-active">[&#8226;](#H4821)</span><span class="bullet mslide20m">[&#8226;](#He2ae)</span>.fg[].bg[]
## [Environmental conditions](#He059)
]
.mainbar.right-column[


Movement analysis, home range

<img src="assets/openday.png" width="1330" height="568" image style="display: block; margin: auto;" />

]
---

name: He2ae

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[]
## [Polar bear tracking](#H39f1)
## [Trajectory analysis](#H4821) <span class="bullet bullet">[&#8226;](#H4821)</span><span class="bullet bullet-active">[&#8226;](#He2ae)</span>.fg[].bg[]
## [Environmental conditions](#He059)
]
.mainbar.right-column[


<iframe src="https://wwfrussia.shinyapps.io/openday/?showcase=0" width="1330" height="380px" data-external="1" magnify></iframe>

















]
---

name: He059

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[]
## [Polar bear tracking](#H39f1)
## [Trajectory analysis](#H4821)
## [Environmental conditions](#He059) <span class="bullet bullet-active">[&#8226;](#He059)</span><span class="bullet mslide22m">[&#8226;](#H0ca0)</span>.fg[].bg[]
]
.mainbar.right-column[


Sea ice, snow cover, vegetation growth using MODIS data

<img src="assets/modis.png" width="1330" height="568" image style="display: block; margin: auto;" />

]
---

name: H0ca0

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f).fg[]
## [Polar bear tracking](#H39f1)
## [Trajectory analysis](#H4821)
## [Environmental conditions](#He059) <span class="bullet bullet">[&#8226;](#He059)</span><span class="bullet bullet-active">[&#8226;](#H0ca0)</span>.fg[].bg[]
]
.mainbar.right-column[


<iframe src="https://wwfrussia.shinyapps.io/modis?lon=180.5&lat=71.2&zoom=7&date=2022-09-08" width="1330" height="650px" data-external="1"></iframe>


















]
---

name: H7ba7

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f)
]
.mainbar.right-column[


.font78[

 ## Acknowledgement
 
+ Permanent Expedition of Russian Academy of Sciences

   + «The Program For Polar Bear Researches In The Russian Arctic»: Viatcheslav Rozhnov (supervisor), Ilia Mordvintsev (expeditional leader), Eugeniy Ivanov, Sergey Naidenko, Nikita Platonov
   
   + Programs and projects for marine mammals studies 


+ Collaboration, co-organization

   + National park «Russian Arctic»
   
   + National park «Lenskie Stolby», Institute of Biological Problems of the Cryoliptozone (Siberian branch of Russian Academy of Sciences)
   
   + Sergey Kavry, Anatoly Kochnev

+ Support

   + The Arctic Research Center LLC, the scientific institute of PJSC NK Rosneft
   
   + "Study of Rare Animal Species" project of the Russian Geographical Society
   
   + "Master of the Arctic-2021" project of the International Environmental Foundation "Clean Seas" 

   + Chukotka Arctic Research Center
   
   + Alexey Yakovlev
   
]


]
???



 ## Благодарности

+ Участники Постоянно действующей экспедиции РАН

   + «Программа изучения белого медведя в Российской Арктике»: Вячеслав Рожнов (руководитель), Илья Мордвинцев (зам.рук.), Евгений Иванов, Сергей Найденко
   + Программы «Белуха», «Тюлени закрытых водоемов»


+ Соучастники, соорганизаторы

   + НП «Русская Арктика»
   
   + НП «Ленские Столбы», ИБПК СО РАН
   
   + Российский центр освоения Арктики

+ Поддержка

   + НК «Чукотский арктический научный центр»
   
   + Русское географическое общество
   
   + ООО «Арктический Научный Центр» -- научный институт ПАО «НК «Роснефть»

]



---
name: fn
hide: true

.sidebar.left-column[
# [Researches](#H4a95)
# [Field work](#H6e42)
# [Office work](#H201f)
]
.mainbar.right-column[



.footnote.smallest[
****
1. S1B_EW_GRDM_1SDH_20210419T042651_20210419T042751_026531_032B0C_C096
]

]

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"countIncrementalSlides": false,
"ratio": "29:18",
"navigation": {
"scroll": true,
"click": false,
"touch": true
},
"highlightLines": true
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>countdown.knit</title>
  <script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>
  <style type="text/css">.countdown {background: #E5E5FF;position: absolute;cursor: pointer;font-size: 160%;line-height: 1;border-color: #ddd;border-width: 3px;border-style: solid;border-radius: 15px;box-shadow: 0px 4px 10px 0px rgba(50, 50, 50, 0.4);-webkit-box-shadow: 0px 4px 10px 0px rgba(50, 50, 50, 0.4);margin: 0.6em;padding: 10px 15px;text-align: center;z-index: 10;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.countdown {display: flex;align-items: center;justify-content: center;}.countdown .countdown-time {background: none;font-size: 100%;padding: 0;}.countdown-digits {color: inherit;}.countdown.running {border-color: #CBCBCBFF;background-color: #E5E5E5;}.countdown.running .countdown-digits {color: #363636FF;}.countdown.finished {border-color: #DE3000FF;background-color: #F04124;}.countdown.finished .countdown-digits {color: #4A0900FF;}.countdown.running.warning {border-color: #DCC98FFF;background-color: #F6E2A9;}.countdown.running.warning .countdown-digits {color: #403502FF;}.countdown.running.blink-colon .countdown-digits.colon {opacity: 0.1;}.countdown:not(.running) .countdown-controls {display: none;}.countdown-controls {position: absolute;top: -0.5rem;right: -0.5rem;left: -0.5rem;display: flex;justify-content: space-between;margin: 0;padding: 0;}.countdown-controls > button {font-size: 1.5rem;width: 1rem;height: 1rem;display: inline-block;display: flex;flex-direction: column;align-items: center;justify-content: center;font-family: monospace;padding: 10px;margin: 0;background: inherit;border: 2px solid;border-radius: 100%;transition: 50ms transform ease-in-out, 150ms opacity ease-in;--countdown-transition-distance: 10px;}.countdown .countdown-controls > button:last-child {transform: translate(calc(-1 * var(--countdown-transition-distance)), var(--countdown-transition-distance));opacity: 0;color: #363636FF;background-color: #E5E5E5;border-color: #CBCBCBFF;}.countdown .countdown-controls > button:first-child {transform: translate(var(--countdown-transition-distance), var(--countdown-transition-distance));opacity: 0;color: #4A0900FF;background-color: #F04124;border-color: #DE3000FF;}.countdown.running:hover .countdown-controls > button,.countdown.running:focus-within .countdown-controls > button{transform: translate(0, 0);opacity: 1;}.countdown.running:hover .countdown-controls > button:hover,.countdown.running:focus-within .countdown-controls > button:hover{transform: translate(0, calc(var(--countdown-transition-distance) / -2));box-shadow: 0px 2px 5px 0px rgba(50, 50, 50, 0.4);-webkit-box-shadow: 0px 2px 5px 0px rgba(50, 50, 50, 0.4);}.countdown.running:hover .countdown-controls > button:active,.countdown.running:focus-within .countdown-controls > button:active{transform: translate(0, calc(var(--coutndown-transition-distance) / -5));}.countdown.countdown-fullscreen {z-index: 0;}.countdown-fullscreen.running .countdown-controls {top: 1rem;left: 0;right: 0;justify-content: center;}.countdown-fullscreen.running .countdown-controls > button + button {margin-left: 1rem;}</style>
  <script>/* globals Shiny,Audio */
class CountdownTimer {
  constructor (el, opts) {
    if (typeof el === 'string' || el instanceof String) {
      el = document.querySelector(el)
    }

    if (el.counter) {
      return el.counter
    }

    const minutes = parseInt(el.querySelector('.minutes').innerText || '0')
    const seconds = parseInt(el.querySelector('.seconds').innerText || '0')
    const duration = minutes * 60 + seconds

    function attrIsTrue (x) {
      if (x === true) return true
      return !!(x === 'true' || x === '' || x === '1')
    }

    this.element = el
    this.duration = duration
    this.end = null
    this.is_running = false
    this.warn_when = parseInt(el.dataset.warnWhen) || -1
    this.update_every = parseInt(el.dataset.updateEvery) || 1
    this.play_sound = attrIsTrue(el.dataset.playSound)
    this.blink_colon = attrIsTrue(el.dataset.blinkColon)
    this.startImmediately = attrIsTrue(el.dataset.startImmediately)
    this.timeout = null
    this.display = { minutes, seconds }

    if (opts.src_location) {
      this.src_location = opts.src_location
    }

    this.addEventListeners()
  }

  addEventListeners () {
    const self = this

    if (this.startImmediately) {
      if (window.remark && window.slideshow) {
        // Remark (xaringan) support
        const isOnVisibleSlide = () => {
          return document.querySelector('.remark-visible').contains(self.element)
        }
        if (isOnVisibleSlide()) {
          self.start()
        } else {
          let started_once = 0
          window.slideshow.on('afterShowSlide', function () {
            if (started_once > 0) return
            if (isOnVisibleSlide()) {
              self.start()
              started_once = 1
            }
          })
        }
      } else if (window.Reveal) {
        // Revealjs (quarto) support
        const isOnVisibleSlide = () => {
          const currentSlide = document.querySelector('.reveal .slide.present')
          return currentSlide ? currentSlide.contains(self.element) : false
        }
        if (isOnVisibleSlide()) {
          self.start()
        } else {
          const revealStartTimer = () => {
            if (isOnVisibleSlide()) {
              self.start()
              window.Reveal.off('slidechanged', revealStartTimer)
            }
          }
          window.Reveal.on('slidechanged', revealStartTimer)
        }
      } else if (window.IntersectionObserver) {
        // All other situtations use IntersectionObserver
        const onVisible = (element, callback) => {
          new window.IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.intersectionRatio > 0) {
                callback(element)
                observer.disconnect()
              }
            })
          }).observe(element)
        }
        onVisible(this.element, el => el.countdown.start())
      } else {
        // or just start the timer as soon as it's initialized
        this.start()
      }
    }

    function haltEvent (ev) {
      ev.preventDefault()
      ev.stopPropagation()
    }
    function isSpaceOrEnter (ev) {
      return ev.code === 'Space' || ev.code === 'Enter'
    }
    function isArrowUpOrDown (ev) {
      return ev.code === 'ArrowUp' || ev.code === 'ArrowDown'
    }

    ;['click', 'touchend'].forEach(function (eventType) {
      self.element.addEventListener(eventType, function (ev) {
        haltEvent(ev)
        self.is_running ? self.stop() : self.start()
      })
    })
    this.element.addEventListener('keydown', function (ev) {
      if (ev.code === "Escape") {
        self.reset()
        haltEvent(ev)
      }
      if (!isSpaceOrEnter(ev) && !isArrowUpOrDown(ev)) return
      haltEvent(ev)
      if (isSpaceOrEnter(ev)) {
        self.is_running ? self.stop() : self.start()
        return
      }

      if (!self.is_running) return

      if (ev.code === 'ArrowUp') {
        self.bumpUp()
      } else if (ev.code === 'ArrowDown') {
        self.bumpDown()
      }
    })
    this.element.addEventListener('dblclick', function (ev) {
      haltEvent(ev)
      if (self.is_running) self.reset()
    })
    this.element.addEventListener('touchmove', haltEvent)

    const btnBumpDown = this.element.querySelector('.countdown-bump-down')
    ;['click', 'touchend'].forEach(function (eventType) {
      btnBumpDown.addEventListener(eventType, function (ev) {
        haltEvent(ev)
        if (self.is_running) self.bumpDown()
      })
    })
    btnBumpDown.addEventListener('keydown', function (ev) {
      if (!isSpaceOrEnter(ev) || !self.is_running) return
      haltEvent(ev)
      self.bumpDown()
    })

    const btnBumpUp = this.element.querySelector('.countdown-bump-up')
    ;['click', 'touchend'].forEach(function (eventType) {
      btnBumpUp.addEventListener(eventType, function (ev) {
        haltEvent(ev)
        if (self.is_running) self.bumpUp()
      })
    })
    btnBumpUp.addEventListener('keydown', function (ev) {
      if (!isSpaceOrEnter(ev) || !self.is_running) return
      haltEvent(ev)
      self.bumpUp()
    })
    this.element.querySelector('.countdown-controls').addEventListener('dblclick', function (ev) {
      haltEvent(ev)
    })
  }

  remainingTime () {
    const remaining = this.is_running
      ? (this.end - Date.now()) / 1000
      : this.remaining || this.duration

    let minutes = Math.floor(remaining / 60)
    let seconds = Math.ceil(remaining - minutes * 60)

    if (seconds > 59) {
      minutes = minutes + 1
      seconds = seconds - 60
    }

    return { remaining, minutes, seconds }
  }

  start () {
    if (this.is_running) return

    this.is_running = true

    if (this.remaining) {
      // Having a static remaining time indicates timer was paused
      this.end = Date.now() + this.remaining * 1000
      this.remaining = null
    } else {
      this.end = Date.now() + this.duration * 1000
    }

    this.reportStateToShiny('start')

    this.element.classList.remove('finished')
    this.element.classList.add('running')
    this.update(true)
    this.tick()
  }

  tick (run_again) {
    if (typeof run_again === 'undefined') {
      run_again = true
    }

    if (!this.is_running) return

    const { seconds: secondsWas } = this.display
    this.update()

    if (run_again) {
      const delay = (this.end - Date.now() > 10000) ? 1000 : 250
      this.blinkColon(secondsWas)
      this.timeout = setTimeout(this.tick.bind(this), delay)
    }
  }

  blinkColon (secondsWas) {
    // don't blink unless option is set
    if (!this.blink_colon) return
    // warn_when always updates the seconds
    if (this.warn_when > 0 && Date.now() + this.warn_when > this.end) {
      this.element.classList.remove('blink-colon')
      return
    }
    const { seconds: secondsIs } = this.display
    if (secondsIs > 10 || secondsWas !== secondsIs) {
      this.element.classList.toggle('blink-colon')
    }
  }

  update (force) {
    if (typeof force === 'undefined') {
      force = false
    }

    const { remaining, minutes, seconds } = this.remainingTime()

    const setRemainingTime = (selector, time) => {
      const timeContainer = this.element.querySelector(selector)
      if (!timeContainer) return
      time = Math.max(time, 0)
      timeContainer.innerText = String(time).padStart(2, 0)
    }

    if (this.is_running && remaining < 0.25) {
      this.stop()
      setRemainingTime('.minutes', 0)
      setRemainingTime('.seconds', 0)
      this.playSound()
      return
    }

    const should_update = force ||
      Math.round(remaining) < this.warn_when ||
      Math.round(remaining) % this.update_every === 0

    if (should_update) {
      this.element.classList.toggle('warning', remaining <= this.warn_when)
      this.display = { minutes, seconds }
      setRemainingTime('.minutes', minutes)
      setRemainingTime('.seconds', seconds)
    }
  }

  stop () {
    const { remaining } = this.remainingTime()
    if (remaining > 1) {
      this.remaining = remaining
    }
    this.element.classList.remove('running')
    this.element.classList.remove('warning')
    this.element.classList.remove('blink-colon')
    this.element.classList.add('finished')
    this.is_running = false
    this.end = null
    this.reportStateToShiny('stop')
    this.timeout = clearTimeout(this.timeout)
  }

  reset () {
    this.stop()
    this.remaining = null
    this.update(true)
    this.reportStateToShiny('reset')
    this.element.classList.remove('finished')
    this.element.classList.remove('warning')
  }

  setValues (opts) {
    if (typeof opts.warn_when !== 'undefined') {
      this.warn_when = opts.warn_when
    }
    if (typeof opts.update_every !== 'undefined') {
      this.update_every = opts.update_every
    }
    if (typeof opts.blink_colon !== 'undefined') {
      this.blink_colon = opts.blink_colon
      if (!opts.blink_colon) {
        this.element.classList.remove('blink-colon')
      }
    }
    if (typeof opts.play_sound !== 'undefined') {
      this.play_sound = opts.play_sound
    }
    if (typeof opts.duration !== 'undefined') {
      this.duration = opts.duration
      if (this.is_running) {
        this.reset()
        this.start()
      }
    }
    this.reportStateToShiny('update')
    this.update(true)
  }

  bumpTimer (val, round) {
    round = typeof round === 'boolean' ? round : true
    const { remaining } = this.remainingTime()
    let newRemaining = remaining + val
    if (newRemaining <= 0) {
      this.setRemaining(0)
      this.stop()
      return
    }
    if (round && newRemaining > 10) {
      newRemaining = Math.round(newRemaining / 5) * 5
    }
    this.setRemaining(newRemaining)
    this.reportStateToShiny(val > 0 ? 'bumpUp' : 'bumpDown')
    this.update(true)
  }

  bumpUp (val) {
    if (!this.is_running) {
      console.error('timer is not running')
      return
    }
    this.bumpTimer(
      val || this.bumpIncrementValue(),
      typeof val === 'undefined'
    )
  }

  bumpDown (val) {
    if (!this.is_running) {
      console.error('timer is not running')
      return
    }
    this.bumpTimer(
      val || -1 * this.bumpIncrementValue(),
      typeof val === 'undefined'
    )
  }

  setRemaining (val) {
    if (!this.is_running) {
      console.error('timer is not running')
      return
    }
    this.end = Date.now() + val * 1000
    this.update(true)
  }

  playSound () {
    let url = this.play_sound
    if (!url) return
    if (typeof url === 'boolean') {
      const src = this.src_location
        ? this.src_location.replace('/countdown.js', '')
        : 'libs/countdown'
      url = src + '/smb_stage_clear.mp3'
    }
    const sound = new Audio(url)
    sound.play()
  }

  bumpIncrementValue (val) {
    val = val || this.remainingTime().remaining
    if (val <= 30) {
      return 5
    } else if (val <= 300) {
      return 15
    } else if (val <= 3000) {
      return 30
    } else {
      return 60
    }
  }

  reportStateToShiny (action) {
    if (!window.Shiny) return

    const inputId = this.element.id
    const data = {
      event: {
        action,
        time: new Date().toISOString()
      },
      timer: {
        is_running: this.is_running,
        end: this.end ? new Date(this.end).toISOString() : null,
        remaining: this.remainingTime()
      }
    }

    function shinySetInputValue () {
      if (!window.Shiny.setInputValue) {
        setTimeout(shinySetInputValue, 100)
        return
      }
      window.Shiny.setInputValue(inputId, data)
    }

    shinySetInputValue()
  }
}

(function () {
  const CURRENT_SCRIPT = document.currentScript.getAttribute('src')

  document.addEventListener('DOMContentLoaded', function () {
    const els = document.querySelectorAll('.countdown')
    if (!els || !els.length) {
      return
    }
    els.forEach(function (el) {
      el.countdown = new CountdownTimer(el, { src_location: CURRENT_SCRIPT })
    })

    if (window.Shiny) {
      Shiny.addCustomMessageHandler('countdown:update', function (x) {
        if (!x.id) {
          console.error('No `id` provided, cannot update countdown')
          return
        }
        const el = document.getElementById(x.id)
        el.countdown.setValues(x)
      })

      Shiny.addCustomMessageHandler('countdown:start', function (id) {
        const el = document.getElementById(id)
        if (!el) return
        el.countdown.start()
      })

      Shiny.addCustomMessageHandler('countdown:stop', function (id) {
        const el = document.getElementById(id)
        if (!el) return
        el.countdown.stop()
      })

      Shiny.addCustomMessageHandler('countdown:reset', function (id) {
        const el = document.getElementById(id)
        if (!el) return
        el.countdown.reset()
      })

      Shiny.addCustomMessageHandler('countdown:bumpUp', function (id) {
        const el = document.getElementById(id)
        if (!el) return
        el.countdown.bumpUp()
      })

      Shiny.addCustomMessageHandler('countdown:bumpDown', function (id) {
        const el = document.getElementById(id)
        if (!el) return
        el.countdown.bumpDown()
      })
    }
  })
})()
</script>
</head>
<body>
<div class="countdown" id="timer_ec5a618a" data-warn-when="120" data-update-every="15" data-blink-colon="true" tabindex="0" style="bottom:4%;left:0.1%;margin:0em;padding:5px 8px;border-radius:7px;font-size:160%;z-index:100">
<div class="countdown-controls"><button class="countdown-bump-down">−</button><button class="countdown-bump-up">+</button></div>
<code class="countdown-time"><span class="countdown-digits minutes">08</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>
</body>
</html>

  </body>
</html>
