```{r setup, echo=FALSE, include=FALSE}
filetype <- knitr::opts_knit$get("rmarkdown.pandoc.to")[1] ## "revealjs" "html"
sound <- T
isRevealjs <- filetype %in% "revealjs"
# rendertyoe <- rmarkdown::default_output_format(knitr::current_input())$name
rendertype <- rmarkdown::all_output_formats(knitr::current_input())[1]
#knitr::opts_chunk$set(collapse=FALSE,prompt=FALSE,comment=""
#                     ,cache=TRUE
#                     ,echo=FALSE,fig.align="center"
#                     )
'h1' <- function(lab,ref="",center=FALSE,background="",subtitle=FALSE,opt="",radio=F
                ,eval=TRUE) {
   if (!eval)
      return("")
  # subtitle <- FALSE
   if (!nchar(background))
      background <- paste0(ursa::cubehelix(1,dark=61,light=61,hue=1.5),"B0")
   if ((!nchar(ref))&&(length(grep("[А-Яа-я]",lab))>=0)) {
      ref <- basename(tempfile(pattern="",fileext=""))
      ref <- paste0("ref",substr(ref,nchar(ref)-3L,nchar(ref)))
   }
   res <- paste0("# ",lab," {",ifelse(center,".center "," "),"#",ref)
   if (nchar(background)) {
     # background <- normalizePath(background,winslash="/")
     # if (length(grep("^[a-z]\\:",background,ignore.case=TRUE)))
     #    background <- paste0("file:///",background)
      if (!length(grep("(^(http|file)|\\.(jpg|png|gif)$)",background)))
         res <- paste0(res," data-background-color=",background)
      else
         res <- paste0(res," data-background-image=",background)
     # res <- paste0(res," style=\"background:transparent;\"")
   }
   if (sound) {
      if (radio)
         res <- paste0(res," data-background-video=http://radio.4duk.ru/4duk64.mp3")
      else
         res <- paste0(res," data-background-video=https://nplatonov.github.io/transition-dong.mp3")
   }
   if (nchar(opt))
      res <- paste0(res," ",opt)
   res <- paste0(res,"}")
   ##~ res2 <- paste0("<section id=",dQuote(ref)
                ##~ ," class=",dQuote("title-slide slide level1")
                ##~ ," data-background=",dQuote(background),">"
                ##~ ,"<h1>",lab,"</h1></section>")
   if ((filetype %in% "revealjs")&&(subtitle)) {
     # res <- paste0(res,"\n\n###### ",lab," {.slideheader}\n\n")
      res <- paste0("\n\n###### ",lab," {.slideheader}\n\n",res)
      ##~ res2 <- paste0(res2,"<h6 class=",dQuote("slideheader"),">",lab,"</h6>")
   }
   ##~ res2 <- paste0(res2,"</section>")
   ##~ res <- res2
   res
}
'h2' <- function(lab,entry=c("default","first","next","last"),ref=""
                ,center=F,background="",opt="",force=FALSE,eval=TRUE) {
   if (!eval)
      return("")
   mode <- match.arg(entry)
   if (missing(lab)) {
      lab <- getOption("ongoingH2label")
      if (mode %in% c("default"))
         mode <- "next"
      if (!nchar(ref))
         ref <- getOption("ongoingH2ref")
      if (is.null(ref))
         ref <- ""
      else {
         patt <- "(.*\\D)(\\d+)$"
         n <- gsub(patt,"\\2",ref)
         if (n==ref)
            n <- 2L
         else
            n <- as.integer(n)+1L
         ref <- paste0(gsub(patt,"\\1",ref),n)
      }
   }
   else {
      options(ongoingH2label=lab)
     # if (mode %in% c("default"))
     #    mode <- "first"
   }
   if ((filetype %in% c("html"))&&(!force)&&(mode %in% c("next","last")))
      return("")
   transition <- switch(mode
                       ,'first'="slide-in fade-out"
                       ,'next'="fade-in fade-out"
                       ,'last'="fade-in slide-out"
                       ,"slide-in slide-out")
   ##~ res <- paste0("## ",lab," {data-transition=",dQuote(transition)," ",opt
               ##~ # ,ifelse(nchar(lab),"",".dontprint")
                ##~ ,"}")
   if ((!nchar(ref))&&(length(grep("[А-Яа-я]",lab))>=0)) {
      ref <- basename(tempfile(pattern="",fileext=""))
      ref <- paste0("ref",substr(ref,nchar(ref)-3L,nchar(ref)))
   }
   options(ongoingH2ref=ref)
   res <- paste0("## ",lab," {",ifelse(center,".center","")," #",ref)
   res <- paste0(res," data-transition=",dQuote(transition))
   if (nchar(background)) {
     # if (!length(grep("^http",background)))
      res <- paste0(res," data-background=",background)
   }
   if (sound)
      res <- paste0(res," data-background-video=https://nplatonov.github.io/transition-ding.mp3")
   if (mode %in% c("default","first"))
      res <- paste0(res," class=\"putheader\"")
   if (nchar(opt))
      res <- paste0(res," ",opt)
   res <- paste0(res,"}")
   res
}
'h3' <- function(lab,entry=c("default","first","next","last"),ref=""
                ,opt="",force=FALSE) {
   mode <- match.arg(entry)
   if ((filetype %in% c("html"))&&(!force)&&(mode %in% c("next","last")))
      return("")
   if ((!nchar(ref))&&(length(grep("[А-Яа-я]",lab))>=0)) {
      ref <- basename(tempfile(pattern="",fileext=""))
      ref <- paste0("ref",substr(ref,nchar(ref)-3L,nchar(ref)))
   }
   res <- paste0("### ",lab," {#",ref)
   if (nchar(opt))
      res <- paste0(res," ",opt)
   res <- paste0(res,"}")
   res
}
'references' <- function(label="",scale=NA,inline=T) {
   res <- character()
   if (F & !isRevealjs)
      return(res)
   if (!inline) {
      ref <- basename(tempfile(pattern="",fileext=""))
      ref <- paste0("ref",substr(ref,nchar(ref)-3L,nchar(ref)))
      res <- paste0(res,"## {#",ref,"}\n")
   }
   res <- paste0(res,":::{class=\"references\" id=\"refs\"")
   if (!is.na(scale))
      res <- paste0(res," style=\"font-size:",scale,"% !important;\"")
   res <- paste0(res,"}\n:::")
   res
}
```

```{r, include=FALSE, eval=FALSE}
print(c(filetype=filetype,rendertype=rendertype))
```
